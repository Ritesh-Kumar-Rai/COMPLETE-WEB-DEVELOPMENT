// controller for users route

import { asyncHandler } from "../utils/asyncHandler.js";
import {ApiError} from "../utils/ApiError.js";
import { ApiResponse } from "../utils/ApiResponse.js";
import {User} from "../models/user.models.js";

const registerUser = asyncHandler(async (req, res) => {
    const {fullName, username, email, password} = req.body;
    console.log(fullName, username, email, password)
    if([fullName, username, email, password].some(field => field?.trim() === '')){
        throw new ApiError(400, "All fields required!");
    }

    const isUserExisted = await User.findOne({
        $or : [{username}, {email}]
    });

    if(isUserExisted){
        throw new ApiError(409, "User with email or username already exists!");
    }

    const avatarImage = req?.files?.avatar[0];

    if(!avatarImage){
        throw new ApiError(400, "`avatar` field is required!");
    }

    let coverImagePath = '';

    if(req?.files && Array.isArray(req?.files?.coverImage) && req?.files?.coverImage?.length > 0){
        coverImagePath = req?.files?.coverImage[0]?.path || '';
    }

    const response = await User.create({
        fullName: fullName?.trim(),
        username: username.trim().toLowerCase(),
        email,
        password,
        avatar: avatarImage?.path,
        coverImage: coverImagePath
    });

    const Re_verifyUserRegistration = await User.findById(response._id, "-password -watchHistory -refreshToken -__v -_id");

    if(!Re_verifyUserRegistration){
        return res.status(500).json(new ApiError(500, "Oops! Something wrong happened while Registering user! Pardon for incovinience", Re_verifyUserRegistration));
    }

    return res.status(201).json(new ApiResponse(200, Re_verifyUserRegistration, "User Registered Successfully."));
});

export {registerUser};


/*
* Steps of logic's:
 -----------------------------

 1. Register User:
            DB schema --> { username, email, password, fullName, watchHistory=[], avatar=img,coverImage=img, refreshToken, [default -> createdAt, updatedAt] }
    COLLECT THE BELOW field:
    VALIDATE EACH FIELD then
    a. username: 
        2 ways: 
            I. get username from user input
            II. auto-generate username by backend
            -> check is username is unique or not -> by quering to db
                            if yes then "continue" else "retry"
    b. email:
        Steps:
            I. get email from user
            II. verify is it exist in db or not (like if another user has created it's acc. via this email or not)
            III. if exists then "retry" else "continue"
    c. password:
        Steps:
            I. get password from user
            II. encrypt the password
            III. then continue
    d. watchHistory: by default [] empty array
    e. avatar: mandatory will get from user then validate then store it to server file using multer
    f. coverImage: optional will get from the user if yes then validate and store file in storage
    g. refreshToken: auto generated by backend server

    STORE IT TO DB:
    then we will store all this field's to MONGODB database by create entry
    - remove password and accesstoken from response of mongodb
    - check for user creation
    - return response to user
*/